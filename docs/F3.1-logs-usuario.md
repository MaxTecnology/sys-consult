# F3.1 – User Activity Log

## O que foi implementado
- Migration `2025_11_13_052501_create_user_activity_logs_table.php`: tabela `user_activity_logs` com user, rota, método, IP, user agent, path e metadata em JSON.
- Model `App\Models\UserActivityLog`: cast de metadata para array.
- Middleware `App\Http\Middleware\LogUserActivity`: registra ação para qualquer request autenticada no painel Filament; ignora campos sensíveis na lista de payload_keys; silencioso em caso de erro.
- Registro do middleware no provider do painel (`Filament\AdminPanelProvider`), garantindo logging automático no `/admin`.
- Resource do Filament para auditoria (apenas admins do Gate `viewUserActivityLogs`), com filtros por usuário, método e status.
- Gate `viewUserActivityLogs` definido em `AppServiceProvider` baseado em `ADMIN_EMAILS` (padrão: admin@admin.com).

## Como testar
1. Executar migrations: `php artisan migrate`.
2. Logar no painel e navegar por algumas páginas (lists, edits).
3. Verificar na base/tinker:
   ```php
   App\Models\UserActivityLog::latest()->take(5)->get();
   ```
   Confirme se `user_id`, `route_name`, `method`, `ip_address` e `metadata['payload_keys']` estão preenchidos.

## Próximos incrementos (opcionais)
- [Feito] Resource Filament apenas para admin visualizar logs (gate `viewUserActivityLogs`).
- [Feito] `request_id`/`trace_id` adicionados na metadata e enviados em `X-Request-Id`.
- [Feito] Filtro no middleware para ignorar rotas de assets/livewire/health e reduzir volume.
- [Feito] Logs de jobs/serviços incluem `request_id` e uso de LogSanitizer para evitar segredos.
- (Opcional) Exibir `request_id` em telas de erro e correlacionar com logs de jobs/filas.

---
Última revisão: 2025-11-13 05:45 UTC.
